import React from 'react';
import {ScrollView, View, Text, TouchableOpacity, StyleSheet, TextInput, Image, Alert, Linking, ActionSheetIOS} from 'react-native';
import {inject, observer} from "mobx-react/native";
import ImagePicker from 'react-native-image-crop-picker';
import Icon from "react-native-vector-icons/Ionicons";

@inject('rootStore')
@observer
export default class Profile extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      avatarUrl: undefined,
      nickName: undefined,
      bio: undefined,
      data: {},
      modify: '',
      roomId: '',
    }
  }

  static navigationOptions = {
    title: 'Ë¥¶Âè∑ËÆæÂÆö',
  };

  async modify(item) {
    this.setState({ modify: item });
  }

  async onBlur(item) {
    this.setState({ modify: '' });
    const userData = await this.props.rootStore.StorageStore.constructor.load('user');
    if (this.state[item].length >= 25) {
      await this.props.rootStore.UserStore.toast('warning', `‚ö†Ô∏è ${item} Â≠óÊï∞‰∏çÂæóË∂ÖËøá 25`);
      await this.props.rootStore.UserStore.clearToast();
    }
    if (this.state[item] !== '' && this.state[item].length < 50) {
      await this.props.rootStore.UserStore.setProfile(userData.token, {
        [item]: this.state[item],
      });
      await this.getProfile();
    } else {
      this.setState({
        [item]: this.state.data[item],
      });
    }
  }

  onChangeName = (nickName) => {
    this.setState({ nickName: nickName.trim() });
  };

  onChangeBio = (bio) => {
    this.setState({ bio: bio.trim() });
  };

  async getProfile() {
    const userData = await this.props.rootStore.StorageStore.constructor.load('user');
    const userProfile = await this.props.rootStore.UserStore.profile(userData.token);
    this.setState({
      avatarUrl: userProfile.data.avatarUrl,
      nickName: userProfile.data.nickName,
      bio: userProfile.data.bio,
      data: userProfile.data,
    });
  }

  async _showActionSheet() {
    ActionSheetIOS.showActionSheetWithOptions({
      options: ['‰ªéÁõ∏ÂÜåÈÄâÂèñ', 'ÂèñÊ∂à'],
      cancelButtonIndex: 1,
      title: 'ËÆæÁΩÆÂ§¥ÂÉè'
    }, async (buttonIndex) => {
      if (buttonIndex !== 1) {
        await this.setAvatar();
      }
    });
  }

  async requestPermission() {
    await Alert.alert(
      'ÊéàÊùÉËØ∑Ê±Ç',
      '\nËÆæÁΩÆÂ§¥ÂÉèÈúÄË¶ÅÁõ∏ÂÜåÊùÉÈôêÔºåËÆæÂ•ΩÂ§¥ÂÉèÂêéÊÇ®ÂèØÂú®ËÆæÁΩÆ‰∏≠ÂÖ≥Èó≠ÊéàÊùÉ',
      [
        {text: 'ÂèñÊ∂à', style: 'cancel'},
        {text: 'ÂéªÊéàÊùÉ', onPress: async () => {
            await Linking.openURL("App-Prefs:root=WIFI");
          }},
      ]
    )
  };

  async selectAvatar() {
    try {
      return await ImagePicker.openPicker({
        cropping: true,
        width: 72,
        height: 72,
        cropperCircleOverlay: true,
        cropperChooseText: 'ÈÄâÊã©',
        cropperCancelText: 'ÂèñÊ∂à',
        loadingLabelText: 'Â§ÑÁêÜ‰∏≠',
        mediaType: 'photo',
        smartAlbums: ['RecentlyAdded', 'UserLibrary'],
        compressImageMaxWidth: 288,
        compressImageMaxHeight: 288,
        forceJpg: true,
      });
    } catch (e) {
      if (e.toString().includes('Cannot access images')) {
        await this.requestPermission();
      } else if (!e.toString().includes('User cancelled')){
        await this.props.rootStore.UserStore.toast('error', `üíä ${e.toString()}`);
        await this.props.rootStore.UserStore.clearToast();
      }
    }
  };

  async uploadAvatar(info) {
    const file = { uri: info.path, type: 'multipart/form-data', name: info.creationDate };
    let formData = new FormData();
    formData.append("smfile", file);
    const response = await fetch('https://sm.ms/api/upload', {
      method: 'POST',
      headers:{
        'Content-Type':'multipart/form-data',
      },
      body: formData,
    });
    return await response.json();
  }

  async setAvatar() {
    const result = await this.selectAvatar();
    if (result !== undefined) {
      if (result.size < 5242880) {
        await this.props.rootStore.LoadingStore.loading(true, '‰∏ä‰º†‰∏≠');
        const response = await this.uploadAvatar(result);
        if (response.code !== 'success') {
          await this.props.rootStore.LoadingStore.loading(false);
          await this.props.rootStore.UserStore.toast('error', `üíä ${response.msg}`);
          await this.props.rootStore.UserStore.clearToast();
        } else {
          const userData = await this.props.rootStore.StorageStore.constructor.load('user');
          await Promise.all([
            this.setState({
              avatarUrl: response.data.url,
            }),
            this.props.rootStore.UserStore.setProfile(userData.token, {
              avatarUrl: response.data.url,
            }),
          ]);
          await this.getProfile();
          await this.props.rootStore.LoadingStore.loading(false);
        }
      } else {
        await this.props.rootStore.UserStore.toast('error', 'üíä Êñá‰ª∂Â§™Â§ßÔºåË£ÅÂâ™‰∏Ä‰∏ãÊàñËÄÖÊç¢‰∏ÄÂº†Â∞è‰∫é 5M ÁöÑÂõæÁâáÂêß');
        await this.props.rootStore.UserStore.clearToast();
      }
    }
  }

  async changeXifu(xifuUser) {
    if (xifuUser === '') await this.props.navigation.navigate('Card');
    if (xifuUser !== '') await Alert.alert(
      'Á°ÆËÆ§ÈÄÄÂá∫ÂêóÔºü',
      '\nÈÄÄÂá∫ÂêéÔºåÊÇ®ÈúÄË¶ÅÈáçÊñ∞ÁôªÂΩïÂñú‰ªòÊâçËÉΩÊü•Áúã‰∏ÄÂç°ÈÄöÂíåÁîµË¥π‰ø°ÊÅØ',
      [
        {text: 'ÂèñÊ∂à', style: 'cancel'},
        {text: 'Á°ÆÂÆö', onPress: async () => {
            await this.props.rootStore.StorageStore.constructor.remove('xifu');
            await this.props.rootStore.StorageStore.constructor.remove('roomId');
            await this.props.rootStore.xiFuStore.setBind(false, '');
            await this.setState({ roomId: 'Êú™Áü•' });
            await this.props.rootStore.UserStore.toast('success', 'üéâ Â∑≤ÊàêÂäüÈÄÄÂá∫ÁôªÂΩï');
            await this.props.rootStore.UserStore.clearToast();
          }},
      ]
    )
  }

  async changeRoom() {
    if (this.state.roomId !== 'Êú™Áü•') {
      await this.props.navigation.navigate('ChangeRoom');
    } else {
      await this.props.rootStore.UserStore.toast('info', 'üç≠ ËØ∑ÂÖàÁªëÂÆöÂñú‰ªòË¥¶Êà∑');
      await this.props.rootStore.UserStore.clearToast();
    }
  }

  async getRoomId() {
    try {
      const roomId = await this.props.rootStore.StorageStore.constructor.load('roomId');
      this.setState({ roomId });
    } catch (e) {
      this.setState({ roomId: 'Êú™Áü•' });
    }
  }

  async exit() {
    await Alert.alert(
      'Á°ÆËÆ§ÈÄÄÂá∫ÂêóÔºü',
      '\nÈÄÄÂá∫ÂêéÂ∞ÜÊ∏ÖÈô§ÊÇ®ÁöÑÁºìÂ≠òÊï∞ÊçÆÔºåÂπ∂Ë¶ÅÊ±ÇÊÇ®ÈáçÊñ∞ÁôªÂΩï',
      [
        {text: 'ÂèñÊ∂à', style: 'cancel'},
        {text: 'Á°ÆÂÆö', onPress: async () => {
            await this.props.rootStore.StorageStore.constructor.remove('user');
            await this.props.rootStore.StorageStore.constructor.remove('course');
            await this.props.rootStore.StorageStore.constructor.remove('exam');
            await this.props.rootStore.StorageStore.constructor.remove('grade');
            await this.props.rootStore.StorageStore.constructor.remove('gpa');
            await this.props.rootStore.StorageStore.constructor.remove('allGrade');
            await this.props.rootStore.StorageStore.constructor.remove('xifu');
            await this.props.rootStore.StorageStore.constructor.remove('roomId');
            await this.props.rootStore.xiFuStore.setBind(false, '');
            await this.props.rootStore.UserStore.toast('success', 'üéâ Â∑≤ÊàêÂäüÈÄÄÂá∫ÂΩìÂâçË¥¶Âè∑ÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
            await this.props.rootStore.UserStore.clearToast();
            await this.props.navigation.navigate('Login');
          }},
      ]
    )
  }

  async delete() {
    await Alert.alert(
      'Á°ÆËÆ§Âà†Èô§ÂêóÔºü',
      '\n‰∏∫‰øùËØÅ‰∏∫Êú¨‰∫∫Êìç‰ΩúÔºåÊ≠§Êìç‰ΩúÈúÄË¶ÅÁ°ÆËÆ§ÊÇ®ÁöÑÊïôÂä°Á≥ªÁªüË¥¶Êà∑ÂØÜÁ†Å',
      [
        {text: 'ÂèñÊ∂à', style: 'cancel'},
        {text: 'Á°ÆÂÆö', onPress: async () => {
            await this.props.navigation.navigate('Confirm');
          }},
      ]
    )
  }

  async componentDidMount() {
    await this.props.rootStore.LoadingStore.loading(true, 'ÂêåÊ≠•‰∏≠...');
    // ‰ªé mobx Ëé∑Âèñ user porfile
    // Â¶ÇÊûúÊ≤°ÊúâÂ∞±‰ªé‰∫ëÁ´ØÊãâÂèñ
    try {
      const userProfile = this.props.rootStore.UserStore.allData.profile;
      this.setState({
        avatarUrl: userProfile.data.avatarUrl,
        nickName: userProfile.data.nickName,
        bio: userProfile.data.bio,
        data: userProfile.data,
      });
    } catch (e) {
      await this.getProfile();
    }

    // ‰ªéÂ≠òÂÇ®ÊãâÂñú‰ªòÁªëÂÆöÁä∂ÊÄÅ
    // Â¶ÇÊûúÊ≤°ÊúâÂ∞±‰ªé store ÈáåÂèñ
    try {
      const xiFuData = await this.props.rootStore.StorageStore.constructor.load('xifu');
      await this.props.rootStore.xiFuStore.setBind(true, xiFuData.username);
      await this.setState({
        xiFuUser: xiFuData.username,
      });
    } catch (err) {
      await this.setState({
        xiFuUser: this.props.rootStore.xiFuStore.allData.xiFuUser,
      })
    }

    await this.getRoomId();
    await this.props.rootStore.LoadingStore.loading(false);
  }

  render() {
    const hash = {
      avatarUrl: 'Â§¥ÂÉè',
      nickName: 'ÊòµÁß∞',
      bio: '‰∏™ÊÄßÁ≠æÂêç',
      stuID: 'Â≠¶Âè∑',
      stuName: 'ÂßìÂêç',
      enName: 'Ëã±ÊñáÂêç',
      gender: 'ÊÄßÂà´',
      grade: 'ÊâÄÂú®Âπ¥Á∫ß',
      plan: 'Â≠¶Âà∂',
      project: 'È°πÁõÆ',
      level: 'Â≠¶ÂéÜÂ±ÇÊ¨°',
      category: 'Â≠¶ÁîüÁ±ªÂà´',
      department: 'Èô¢Á≥ª',
      profession: '‰∏ì‰∏ö',
      direction: '‰∏ì‰∏öÊñπÂêë',
      enrollDate: 'ÂÖ•Ê†°Êó∂Èó¥',
      graduateDate: 'Â∫îÊØï‰∏öÊó∂Èó¥',
      manager: 'Ë°åÊîøÁÆ°ÁêÜÈô¢Á≥ª',
      waysOfLearning: 'Â≠¶‰π†ÂΩ¢Âºè',
      eduForm: 'ÊïôËÇ≤ÂΩ¢Âºè',
      status: 'Â≠¶Á±çÁä∂ÊÄÅ',
      registered: 'ÊòØÂê¶Âú®Á±ç',
      atSchool: 'ÊòØÂê¶Âú®Ê†°',
      class: 'Ë°åÊîøÁè≠Á∫ß',
      campus: 'ÊâÄÂ±ûÊ†°Âå∫',
    };

    const Info = () => Object.keys(this.state.data).map((item, key) => {
      if (key !== 0 && key !== 1 && key !== 2) {
        return <View key={key} style={[styles.item, item === 'campus' && styles.last]}>
          <Text style={styles.leftText}>{hash[item]}</Text>
          <Text style={styles.rightText}>{this.state.data[item]}</Text>
        </View>
      }
    });

    return (
      <ScrollView style={styles.scrollView}>
        <Text style={styles.title}>‰∏™‰∫∫ËÆæÂÆö</Text>
        <View style={styles.container}>
          <TouchableOpacity style={styles.touchable} onPress={this._showActionSheet.bind(this)}>
            <Text style={styles.leftText}>Â§¥ÂÉè</Text>
            {this.state.avatarUrl === undefined ? <Text style={styles.rightText}>ÁÇπÂáªËÆæÁΩÆ</Text> : <Image source={{ uri: this.state.avatarUrl }} resizeMode='contain' style={styles.logo}/>}
          </TouchableOpacity>
          <TouchableOpacity
            style={[styles.touchable, this.state.modify === 'nickName' && styles.edit]}
            onPress={this.modify.bind(this, 'nickName')}
          >
            <Text style={styles.leftText}>{hash['nickName']}</Text>
            {this.state.modify === 'nickName' ?
              <TextInput
                style={styles.Input}
                editable={true}
                keyboardType='default'
                maxLength={25}
                autoFocus
                placeholder='ËæìÂÖ•ÊòµÁß∞'
                returnKeyType='done'
                onChangeText={this.onChangeName}
                onBlur={() => this.onBlur('nickName')}
              /> :
              <Text style={styles.rightText}>{this.state.nickName === undefined ? 'ÁÇπÂáªËÆæÁΩÆ' : this.state.nickName}</Text>
            }
          </TouchableOpacity>
          <TouchableOpacity
            style={[styles.touchable, this.state.modify === 'bio' && styles.edit]}
            onPress={this.modify.bind(this, 'bio')}
          >
            <Text style={styles.leftText}>{hash['bio']}</Text>
            {this.state.modify === 'bio' ?
              <TextInput
                style={styles.Input}
                editable={true}
                keyboardType='default'
                maxLength={25}
                autoFocus
                placeholder='ËæìÂÖ•‰∏™ÊÄßÁ≠æÂêç'
                returnKeyType='done'
                onChangeText={this.onChangeBio}
                onBlur={() => this.onBlur('bio')}
              /> :
              <Text style={styles.rightText}>{this.state.bio === undefined ? 'ÁÇπÂáªËÆæÁΩÆ' : this.state.bio}</Text>
            }
          </TouchableOpacity>
          <TouchableOpacity style={styles.touchable} onPress={this.changeXifu.bind(this, this.state.xiFuUser)}>
            <Text style={styles.leftText}>Âñú‰ªòË¥¶Êà∑</Text>
            <Text style={styles.rightText}>{this.props.rootStore.xiFuStore.allData.xiFuBind === false && this.props.rootStore.xiFuStore.allData.xiFuUser === '' ? 'ÁÇπÂáªÁªëÂÆö' : this.state.xiFuUser}</Text>
          </TouchableOpacity>
          <TouchableOpacity style={[styles.touchable, styles.last]} onPress={this.changeRoom.bind(this)}>
            <Text style={styles.leftText}>ÂÆøËàç</Text>
            <Text style={styles.rightText}>{this.state.roomId}</Text>
          </TouchableOpacity>
        </View>
        <Text style={styles.title}>Ë¥¶Êà∑ÁÆ°ÁêÜ</Text>
        <View style={styles.container}>
          <TouchableOpacity style={styles.touchable} onPress={this.exit.bind(this)}>
            <Text style={styles.leftText}>ÈÄÄÂá∫ÁôªÂΩï</Text>
            <Icon style={styles.rightIcon} name="ios-arrow-forward" size={21}/>
          </TouchableOpacity>
          <TouchableOpacity style={[styles.touchable, styles.last]} onPress={this.delete.bind(this)}>
            <Text style={styles.leftText}>Âà†Èô§Ë¥¶Êà∑</Text>
            <Icon style={styles.rightIcon} name="ios-arrow-forward" size={21}/>
          </TouchableOpacity>
        </View>
        <Text style={styles.title}>Â≠¶Á±ç‰ø°ÊÅØ(‰∏çÂèØ‰øÆÊîπ)</Text>
        <View style={styles.container}>
          <Info/>
        </View>
        <Text style={styles.note}>Êàë‰ª¨‰∏çÊî∂ÈõÜÊàñÂÖ±‰∫´ÊÇ®ÁöÑ‰∏™‰∫∫‰ø°ÊÅØ</Text>
      </ScrollView>
    )
  }
}

const $white = '#fff';
const $titleColor = 'rgb(109, 109, 114)';
const $borderColor = 'rgb(200, 199, 204)';
const $text = 'rgb(3,3,3)';
const $gray = 'rgb(143, 142, 148)';
const styles = StyleSheet.create({
  scrollView: {
    height: '100%',
  },
  container: {
    paddingLeft: 15,
    backgroundColor: $white,
    borderBottomWidth: 0.5,
    borderBottomColor: $borderColor,
    borderTopWidth: 0.5,
    borderTopColor: $borderColor,
  },
  title: {
    paddingLeft: 15,
    paddingTop: 15,
    paddingBottom: 7,
    color: $titleColor
  },
  touchable: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingRight: 15,
    paddingTop: 13,
    paddingBottom: 13,
    borderBottomWidth: 0.5,
    borderBottomColor: $borderColor,
  },
  edit: {
    justifyContent: 'flex-start',
  },
  item: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingRight: 15,
    borderBottomWidth: 0.5,
    borderBottomColor: $borderColor,
    height: 44,
  },
  last: {
    borderBottomWidth: 0,
  },
  leftText: {
    fontSize: 17,
    color: $text,
  },
  Input: {
    marginLeft: 15,
    width: '100%'
  },
  rightText: {
    fontSize: 14,
    color: $gray,
  },
  logo: {
    width: 72,
    height: 72,
    borderRadius: 36,
  },
  rightIcon: {
    color: $gray,
  },
  note: {
    paddingBottom: 20,
    textAlign: 'center',
    paddingTop: 20,
    color: $titleColor
  }
});